---
title: "設計②：電卓が持つ機能と情報"
---

## 本項について

前項で、電卓をステートマシンと見立てた場合の動作を説明しました。ここからはその内容を基に、電卓というモノに対して、どのような機能を実装し、どのような情報を持たせるかについて考えていきます。

### 電卓が持つべき機能

まずは電卓ができることに注目し、実装すべき機能について見ていきます。

#### 式の入力

まずは電卓に対し、式を入力できることが必要です。

![人が電卓に「式に入力して」と「１」を渡している状況。電卓は持っている式「１＋」に「１」を付け加え、状態を「演算子」から「右辺」へ遷移させる](/images/books/howto-create-calculator/action-input-01.png)

ただし、状態管理で「入力できない値」を弾く必要があります。

![人が電卓に「式に入力して」と「＋」を渡している状況。電卓は持っている式「１＋」と状態を「演算子」から、「この状態で ＋ を入力することはできません」と拒絶する](/images/books/howto-create-calculator/action-input-02.png)

#### 計算実行

次に、電卓に対して計算を実行させる処理が必要となります。

![人が電卓に「計算して」と命令している状況。電卓は持っている式「１＋１」を計算し「２」に更新する、また状態を「右辺」から「計算結果」へ遷移させる](/images/books/howto-create-calculator/action-calculate.png)

:::message

先程の「式の入力」にまとめることもできそうですが、処理の便宜上、別の処理として扱っていきます。

これは状態「右辺」から「計算結果」へ遷移する処理（例：`1+1` に `=` を入力）と、「右辺」から「演算子」へ遷移する処理（例：`1+1` に `+` を入力）は別個の流れを辿りますが、計算処理自体は共通しているからです。

:::

#### リセット

次に計算機に対し、状態や式をリセットさせる機能も必要です。

![人が電卓に「リセットして」と命令している状況。電卓は持っている式「1+1」と状態「右辺」を廃棄し、空欄の式と初期状態にリセットされる](/images/books/howto-create-calculator/action-reset.png)

#### バックスペース

最後に、入力ミス等で１文字訂正する機能が必要でしょう。

![人が電卓に「１字戻して」と命令している状況。電卓は持っている式「1+1」を「1+」に修正し、状態を「右辺」から「演算子」へ戻す](/images/books/howto-create-calculator/action-backspace-01.png)

### 電卓が持つべき情報

次に、上記の機能に対して電卓はどのような情報を持つべきかを考えていきます。

#### 式

まず思いつくのは、入力された**式**です。これを持っていないと、電卓は計算することも、バックスペースすることもできません。

#### 状態

式の他には、ステートマシンとしての状態情報を持つ必要もあるでしょう。自身がどの状態にいるかで、入力に対する反応が変化するためです。

### その他について

ここまでは、電卓自身が持つべき機能や情報について説明しました。ここでは それ以外（電卓自身が保持する必要がないもの）を見ていきます。

#### 式へ入力可能な情報

[式の入力](#式の入力)では、無関係な `A` や `@` などが入力値になるべきではありません。そのため、入力として受け入れる値（数値や演算子など）をどこかで定義しておくべきでしょう。

羅列すると `0`, `1`, `2`, `3`, `4`, `5`, `6`, `7`, `8`, `9`, `.`, `=`, `+`, `-`, `*`, `/` が、入力可能な情報です。

#### 特定の状態下で入力不可な情報

先ほどの入力可能な情報は、電卓全体の話であって、特定の状態下では制限される場合があります。下表が、各状態下で入力できない情報をまとめたものになります。

|状態名|式の例|制限される入力値|
|:---|:---|:---|
|初期状態|（なし）|`["+", "*", "/", "="]`|
|負数状態１|`-`|`["+", "-", "*", "/", "="]`|
|左辺ゼロ入力|`0`, `-0`|`["0", "="]`|
|左辺整数入力|`1`, `12`, `-1`|`["="]`|
|左辺小数入力|`0.`, `0.1`|`[".", "="]`|
|演算子|`1+`, `0.12*`|`["+", "*", "/", "="]`|
|負数入力２|`1+-`, `1--`|`["+", "-", "*", "/", "="]`|
|右辺ゼロ入力|`1+0`, `1+-0`|`["0"]`|
|右辺整数入力|`1+1`, `1+123`|`[]`|
|右辺小数入力|`1+0.`, `1*0.1`|`["."]`|
|計算結果|`2`|`["="]`|

適切でない入力を弾くために、上記の情報もどこかで定義しておくべきしょう。

:::message

「特定の状態下で入力**可能**な情報を扱えば、上記２つを１つにまとめられるのでは？」と思うかもしれません。本書では、後々の拡張（例：`√` や `%` を使った機能）が難しくなりそうと考え、電卓全体で入力可能な情報と、状態に絡めた入力不可な情報を 分けて管理しています。

:::

#### 四則演算処理関係（丸め誤差を回避する場合）

:::message

本項目は、下記項目が該当する場合のみ必要なものになります。

- そのまま計算すると、丸め誤差が生じる可能性がある
- そのため、一度小数を整数化した上で、計算処理後に復元する必要がある

JavaScript は丸め誤差が生じる言語ですが、`Decimal.js` などの外部ライブラリを利用することで回避は可能です。

:::

言語に組み込まれている四則演算処理をそのまま使えない場合、専用の処理を設ける必要があります。
