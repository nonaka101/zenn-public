---
title: "応用①：HTML要素との連携"
---

## 本項について

ここでは 作成段階で作った `Calculator` クラスを使って、HTML要素で表示・操作できるようしていきます。

## 設計

まずは、目標となるイメージ図を描き、そこからどのような設計にしていくかを考えていきます。

### HTML要素との連携

HTML上で表示・操作するクラス `htmlCalculator` を作るのが、ここでの目的となります。そのために、既存の `Calculator` をどう扱うかについて考えます。

#### `Calculator`クラス

既存の `Calculator` では、以下のことができます。

- 式（文字列）と状態（数値）を情報として保持
- `expression` プロパティで、式を取得できる
- `pushExpression(input)` で式に情報を入力できる
- 計算が必要なタイミングで `calculate()` が呼び出され、式は計算値に上書きされる
- `reset()` で式と状態を初期値に戻せる
- `back()` で、末尾文字を除いた式に再計算される

#### `htmlCalculator`クラス

ここで、HTMLを操作できる `htmlCalculator` クラスを考えます。これには、下図のような役割を持たせたいです。

##### 式情報の表示

まずは、クラスが保持している**式情報を人が見れるよう表示**（出力）する機能が欲しいです。これは下図のようなイメージでしょうか。

![Calculatorが持つ式情報を、HTML要素側へ出力している図](/images/books/howto-create-calculator/html-calculator-02.png)
*式`1+1`を表示出力*

さらに**計算処理時には、計算式を別途ラベルという形で保管し、計算式と計算値の両方を見える状態**にしたいです。そうなると、下図のように2個所へ表示することになります。

![Calculator内で計算処理が行われ、式と計算値を別々の場所へ出力している](/images/books/howto-create-calculator/html-calculator-03.png)
*`1+1`に`=`が入力された際、計算式とその結果を個別に表示*

上側にある補足欄には 計算式を保管するだけでなく、例えばエラー情報等を載せることにも使えそうです。

![Calculator内で入力処理が行われる際、不正な入力値であることを補足欄に出力するよう送っている](/images/books/howto-create-calculator/html-calculator-04.png)
*`1+`に`+`が入力された際、入力できない旨を表示*

このように、式情報の欄は補足欄含めた2つで運用するのが良さそうです。

##### ボタンとの連携

既存の `Calculator` クラスは、コンソール上で定義した変数に対し `pushExpression('1')` で操作する必要があります。

わざわざコードを打ち込んで操作するのは面倒なので、これをボタンで入力できるようにしたいです。

![ボタンUIから、Calculatorへ入力操作できるように結びつけている](/images/books/howto-create-calculator/html-calculator-05.png)
*`Calculator` の `pushExpression()`を拡張し、ボタンUIで入力可能なように改修*

それとは別に、電卓が保持している状態情報を使えば**入力できない値**がわかります。であれば、事前にそのボタンを操作不能にすることで、ユーザーが誤入力することを防げそうです。

![CalculatorからボタンUIへ、ボタンの不活性化を操作している](/images/books/howto-create-calculator/html-calculator-06.png)
*`htmlCalculator` 側でボタンの活性・非活性化を管理できるメソッドを、新規に追加*

`button` 要素の `disabled` を操作すれば、押下することができず不正な入力自体ができなくなります。フォーカスもできず、スクリーンリーダーも読み上げ対象から外れるので、操作の簡略化にも繋がりそうです。

:::details 補足：disable属性時に生じる斜線について

色の違いでなく、パターンでの識別を可能にするためです。

![背景が灰色の✕ボタン、その全体に対して右下の部分に白い斜線を引いている](/images/books/howto-create-calculator/button-disabled-01.png =100x)

スタイルに関する話なので簡単な説明になりますが、このボタン郡はパターンによる区分もできるように設計しています。ただ、`disabled` を単純に灰色で表現してしまうと、ロービジョンのシミュレーション時、押せるものとの区別が付きづらくなっていました。そのため斜線を引いてパターンによる表現を取り入れています。  
※ ただ、中央に引いてしまうと文字が見づらくなるので、ラベルにかからない位置に引くようにしています。

:::

### 既存クラスの位置づけ

上記の役割を新規クラスに持たせるために、下図のような構成にしていきます。

![htmlCalculator と HTML要素の関係図](/images/books/howto-create-calculator/html-calculator-01.png)

:::message

設計前のイメージ図なので、ごちゃごちゃしたものになっています。見てほしい要点は、下記のとおりです。

- `Calculator` クラスを**内包する形**で `htmlCalcuator` クラスを作る
- `Calculator` が持っていない情報 `_label` やボタン操作メソッド `refreshButtons()` を新規に追加
- `Calculator` が持っていた各種メソッドを、HTMLを操作できるように拡張している
- （上記の）拡張した部分に、HTML要素を関連付けている

:::

このようなイメージから、今回は `extends`, `super` キーワードを使った**サブクラスを定義し、HTML要素を扱えるよう設計**（既存メソッドにもオーバーライドを施す）していきます。

:::details 継承でなく委譲に基づいた別手法

今回選ばなかった手法として、新規クラス内に `Calculator` インスタンスを作成して管理する（≒ 新規クラスでラップする）方法があります。これは、例えば下記のような形です。

```javascript
class Calculator(){
  // 省略
}

class htmlCalculator(){
  constructor(){
    this._core = new Calculator();
  }

  get expression(){
    return this._core.expression;
  }

  pushExpression(input){
    //【入力前のHTML操作がここに入る】

    this._core.pushExpression(input);

    //【入力後のHTML操作がここに入る】
  }
}
```

このように `_core` 内に `Calculator` インスタンスを格納しておき、必要なタイミングで振る舞いを委譲することで、今回の結果と似たことができるようになります。委譲についての考えは、『JavaScript 第7版』にある内容を参考にしています（下記はその一部を抜粋したものです）。

> 新しいクラスを作成するときに、サブクラス化するのではなく、ほかのクラスをラップするのです。このような委譲という方法は「合成（Composition）」と呼ばれるものです。オブジェクト指向プログラミングでよく知られている原則に「継承よりも合成を優先」というものがあります。
> 著：David Flanagan　訳：村上 列　出版：オライリー・ジャパン『JavaScript 第7版』P264 より一部抜粋

ただ今回に関しては、下記の事由より委譲でなく継承で問題ないと考え、サブクラスによる手法を採用しました。

- `Calculator` クラスの機能を（一部でなく）そのまま使いたい
- `htmlCalculator` に期待する処理（入力、バックスペース、リセット）は、`Calculator` と一致している

:::
