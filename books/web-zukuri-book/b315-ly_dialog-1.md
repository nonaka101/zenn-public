---
title: "📄B315：ly_dialog(1)"
---

## このページについて

![ダイアログメニューのスクリーンショット](/images/books/web-zukuri/ly_dialog-01.png)

ここではモバイル画面時に表示される「メニューダイアログ」について扱います。

アクセシビリティなダイアログ要素にするためには、JavaScript と WAI-ARIA の使用が必要となり、少し複雑になります。そのためこの話は3回に分割し、今回はスタイルの話を除いた部分を解説していきます。

## 構造の定義

まずは、どのような構造にするかを決めていきます。ダイアログメニューで必要となる要件は、下記のとおりです。

- ボタン押下により、メニューを展開する
  - 逆に言えば、ボタンを押さない限りメニューは格納状態（≒スクリーンリーダーによる読み上げ対象からは外れる）
  - 展開/格納状態がスクリーンリーダー操作者に伝わる
- ダイアログ展開時は**モーダル状態**となる
  - ダイアログメニューを画面最前面に表示
  - 中の要素が多ければ、縦方向へのスクロールで移動できる
  - 一方で、ダイアログ外の要素による縦スクロールは制限する
  - フォーカスは制御され、ダイアログ外にフォーカスが移らない
  - ダイアログは、下記により閉じることができる
    - ダイアログ内に用意した「閉じる」ボタン
    - Escキー による操作
    - ダイアログ要素の範囲外をクリック

このようにモーダルダイアログについては、要件が複雑になります。なので、もう少し細かく解説していきます。

### （モーダル）ダイアログの展開

ダイアログは、`button` 要素と連携して要素の開閉（展開/格納）を行います。アコーディオンと似ていますが、**モーダル**ダイアログに関しては制御が移ることに特徴があります。

本テーマを使って説明すると、下図のようなイメージです。

![ダイアログのイメージ図。メイン画面とダイアログ画面があり、それぞれが別個にあることを強調している](/images/books/web-zukuri/ly_dialog-02.png)

このように、**メイン画面とダイアログ画面が別個に存在している**イメージで、ボタンによって制御が切り替わります。制御が片方に移っている時、もう片方はスクリーンリーダーの読み上げ対象になりませんし、フォーカスを移すこともできません。つまりモーダルダイアログが展開している状態においては、制御がモーダル側に移り、（操作を完了させるなりでダイアログを閉じない限り）メイン画面の操作ができなくなることに特徴があります。

モーダルダイアログはこのような特徴から、下記のような利点があります。

- 重要な情報への注意を促す
- 後戻りできないような重要な場面において、ユーザーが確認したかの能動的な操作を引き出す
- （アプリケーションにおいて）必要な入力をするまで他の操作をさせない

一方で、Webアクセシビリティの観点からは注意が必要になります。適切なダイアログでない場合、スクリーンリーダーを使用するユーザーにとっては下記のような危険性があります。

- ダイアログが展開しているのか格納状態なのかわからない
- 自身がダイアログ内にいることがわからない
- ダイアログを閉じることができない

キーボード操作による閲覧者にとっても、下記のような危険性があるでしょう。

- フォーカスがダイアログ外にいった場合、自身がどこにいるのかわからなくなる
- ダイアログを閉じることができない

このため、Webアクセシビリティを考えた場合には、モーダルダイアログには必ず下記の要件が必要になってきます。

- ダイアログ内で、自身を閉じることができる仕組みを（可能なら複数）用意する
  - 閉じるボタン
  - Escキー
  - ダイアログ外をクリック
- ダイアログ外にフォーカスが移らないようにする
- マシンリーダブルにする
  - 自身がダイアログ要素であること
  - 現在の状態（展開/格納）
  - （展開ボタン）ダイアログを開く動作をすること

### （モーダル）ダイアログの実装について

上記の要件を満たすようにダイアログを作る場合、主に2つの方法が考えられます。

- JavaScript と WAI-ARIA を使う
- `dialog` 要素を使う

前者に関しては、例えば `micromodal.js` などのライブラリを使うことで容易に実装することもできます。また、`dialog` 要素に対応していないブラウザにも対応できるなどのメリットがあります。一方で、WAI-ARIA を使ってモーダルダイアログを再現する以上 ブラウザが使用する WAI-ARIA に対応している必要があります。また配布されてるライブラリを使わず1からの実装となると、複雑な要件を満たすきめ細やかな対応が必要となり、その工数や難易度は高くなることが予想されます。

それに対し後者の `dialog` 要素は、2022年に全ての主要ブラウザが対応するようになった新しい要素です。なので古いブラウザに対応していなかったりする問題はありますが、一方で先程上げたアクセシビリティ要件をブラウザ側で行ってくれるという強力なメリットがあります。対応していないブラウザについては Google がポリフィルを提供しているので、そちらを使用すれば解決することもできそうです。

https://github.com/GoogleChrome/dialog-polyfill

本テーマにおいては、後者の `dialog` 要素を使いモーダルダイアログを実装しています。その理由は、既存のデータやスタイル要件がない 1からの作成であること。そして WAI-ARIA と HTML で同じ機能を果たせる場合、HTMLの方が望ましいと考えていることからです。

## 作成

ここからは、`dialog` 要素と JavaScript を使って基礎構造となるモーダルダイアログを作っていきます。

### `dialog` 要素の作成

まずは `dialog` 要素を設置します。この要素には、JavaScript で操作するため `id` をつけておきます。

```html:ダイアログ要素の設置
<dialog id="menu">
  <!-- メニューコンテンツがここに入る -->
  <!-- ダイアログを閉じるボタンが必要 -->
</dialog>
```

### `dialog` を展開する

次にこの `dialog` 要素を開けるように、ボタンを設置します。

- `aria-controls` で操作対象となるコントロールを指定
- `id` を付与して JavaScript で管理しやすいようにする

```html:本テーマにおける、ダイアログの構成
<!-- メニュー展開ボタン -->
<button type="button" aria-controls="menu" id="menu-button">メニュー</button>

<!-- ダイアログ要素 -->
<dialog id="menu">
  <!-- メニューコンテンツがここに入る -->
  <!-- ダイアログを閉じるボタンが必要 -->
</dialog>
```

ボタンを作成したので、ここから `dialog` を操作できるように JavaScript を作ります。`dialog` 要素をモーダル状態で開くには、`Element.showModal();` が必要です。

```javascript:ダイアログの展開操作
// 各種要素の取得
const menuBtn = document.getElementById('menu-button');
const menuDialog = document.getElementById('menu');

// ボタン押下時、ダイアログをモーダル状態で表示
menuBtn.addEventListener('click', () => {
  menuDialog.showModal();
});
```

### `dialog` を閉じる

最後に、`dialog` を閉じることができるようにします。ここでは3つの方法で閉じることができるようしています。

- Escキーの押下（`dialog` 要素を使っているので、ブラウザが自動的に実装）
- 閉じるボタンの設置（必ず `dialog` 内に置くこと）
- ダイアログ外をクリック

最後については、マウスやタップ操作者に向けたものになります。

```html:本テーマにおける、ダイアログの構成
<!-- メニュー展開ボタン -->
<button type="button" aria-controls="menu" id="menu-button">メニュー</button>

<!-- ダイアログ要素 -->
<dialog id="menu">
  <!-- メニューコンテンツがここに入る -->
  <!-- ダイアログを閉じるボタン -->
  <button type="button" onclick="closeDialog()">メニューを閉じる</button>
</dialog>
```

次に JavaScript です。

```javascript:ダイアログを閉じる操作
const menuDialog = document.getElementById('menu');

// ダイアログを閉じる（ダイアログ内 buttonタグの `onClick` イベントに使用）
function closeDialog(){
  menuDialog.close();
};

// モーダルダイアログ外をクリック時、ダイアログを閉じる
menuDialog.addEventListener('click', (e) => {
  if(e.target === menuDialog){
    menuDialog.close();
  }
});
```

#### ダイアログ外のクリック操作について

最後の `menuDialog.addEventListener(...)` について、説明を加えます。注意すべき点として、現在のテーマではこの機能は動作することはありません。今後ダイアログメニューのレイアウトを変更する可能性を見込み、コードだけが残っている状態です。

当初、ダイアログメニューは **B309:bl_blockSkip** のような形を想定していました。つまり、下記のようになります。

- 幅は中の要素に応じて可変
- 画面中央に表示
- ダイアログ外にはブラーをかける

これで実装する際、HTML構造は下記のようになります。

```html
<!-- ダイアログ：画面全体を覆う -->
<dialog id="menu">
  <!-- コンテンツ：画面中央に配置し、幅は中の要素に応じて可変 -->
  <div>
    <h2>メニュータイトル</h2>
    <!-- その他メニューコンテンツ -->
  </div>
</dialog>
```

![上記のHTML構成のイメージ図、Dialog要素(id=menu) が画面全体にあり、中央にdiv要素がある](/images/books/web-zukuri/ly_dialog-03.png)

これを踏まえ、先程のコードをもう一度見てみます。

```javascript
const menuDialog = document.getElementById('menu');

// モーダルダイアログ外をクリック時、ダイアログを閉じる
menuDialog.addEventListener('click', (e) => {
  if(e.target === menuDialog){
    menuDialog.close();
  }
});
```

`e.target === menuDialog` という条件を満たすのは、下図の部分です。

![中央にある div 要素を除く画面全体が対象であることを示している](/images/books/web-zukuri/ly_dialog-04.png)

よって、このコードでダイアログ外をクリックすることで、ダイアログを閉じることができます。

:::message alert

ただし現在のダイアログは画面全体を使うように変更したため、この機能が動くことはありません。

この変更は、メニュー項目が多くなった際に、上下の余白とスクロールをどうしようかというところが大きく関わってきます。余白を消してしまうと形としては歪になり、スクロールを許可するとメイン画面とダイアログ画面でのスクロール管理が必要になってきます。  
メイン画面はスクロールを固定した状態で、ダイアログ内にスクロールを設ける必要がでてくるということです。

現状、それをするよりは画面全体を専有する形にするほうがいいと判断し、変更をかけました。その方がスペースを気にせずコンテンツを含めることができ、スクロールもわかりやすくなるからです。ダイアログを閉じる方法は1つ消えてしまいますが、残りの2つの方法（閉じるボタンとEscキー）で十分にアクセシビリティを満たせていると考えています。

:::

## 完成形

最後に完成形をまとめておきます。

```html
<!-- メニュー展開ボタン -->
<button type="button" aria-controls="menu" id="menu-button">メニュー</button>

<!-- ダイアログ要素 -->
<dialog id="menu">
  <!-- メニューコンテンツがここに入る -->
  <!-- ダイアログを閉じるボタン -->
  <button type="button" onclick="closeDialog()">メニューを閉じる</button>
</dialog>
```

```javascript:common.js
/* ≡≡≡ ▀▄ 「メニュー」ボタン ▀▄ ≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡
  ■ 概要
    モバイル画面時、ヘッダーにある「メニュー」ボタンを押すと、モーダルダイアログを表示
  ■ 備考
    `showModal()` を使っているため、HTML側で autofocus 属性は不要
    （フォーカスは、自動で近くのフォーカス可能な要素に移るため「閉じる」ボタンが選択される）
---------------------------------------------------------------------------- */

// 各種要素の取得
const menuBtn = document.getElementById('menu-button');
const menuDialog = document.getElementById('menu');

// ボタン押下時、ダイアログをモーダル状態で表示
menuBtn.addEventListener('click', () => {
  menuDialog.showModal();
});

// ダイアログを閉じる（ダイアログ内 buttonタグの `onClick` イベントに使用）
function closeDialog(){
  menuDialog.close();
};

// モーダルダイアログ外をクリック時、ダイアログを閉じる
menuDialog.addEventListener('click', (e) => {
  if(e.target === menuDialog){
    menuDialog.close();
  }
});
```

## まとめ

本項ではメニューダイアログを、主に下記のことについて説明しました。

- ダイアログに求められる機能
- それを達成する手法（WAI-ARIA + JavaScript による方法と、`dialog` 要素の使用）
- `dialog` 要素を使う利点
- HTMLでの実装

次項では 今回作った内容に対し、スタイル方面でブラッシュアップしていくことになります。
