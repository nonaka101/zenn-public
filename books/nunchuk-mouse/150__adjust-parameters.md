---
title: "📄使い方：パラメーターを調整する（任意）"
---

## はじめに

本項では、デフォルト設定から自身に合わせた調整を行なっていく方法について説明します。

:::message

この作業は任意であり、使いづらさを感じた場合に利用してください。

:::

## 調整について

ここでは コード内にある設定項目を書き換え、調整を行なっていく作業について説明します。

本段落で扱う設定項目のコードは、下記のとおりです。

:::details 設定項目全文

```cpp
// ============================================================================
// 設定項目 (User-configurable settings)
// ※このセクション内の値は、好みに応じて調整してください
// ============================================================================

// ◤◢◤◢ デバッグ & LED ◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤

// デバッグモードを有効化する（デフォルト：false）
// ※ デバッグ時は、IDE シリアルモニター上に状態を出力します
const bool ENABLE_DEBUG_MODE = false;

// 状態を可視化するため LED を使用する（デフォルト：true）
// ※ 点灯はホイールモード、点滅は接続エラーを示します
const bool ENABLE_LED = true;

// 使用する LED ピン番号（デフォルト：13）
// ※ ENABLE_LED 有効時に使用します。デフォルトの 13 は、Arduino のオンボード LED です。
const int LEDPIN = 13;

// ◤◢◤◢ デバイス関係 ◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢

// ヌンチャク種別、クロの場合は false に変更（デフォルト：true）
const bool IS_NUNCHUK_SHIRO = true;

// Macintosh の場合は true に変更（デフォルト：false）
const bool IS_MACINTOSH = false;

// ◤◢◤◢ ヌンチャク物理特性のデフォルト値 ◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢

 // スティック X 軸の中心値（デフォルト：128）
const int STICK_CENTER_X = 128;

// スティック Y 軸の中心値（デフォルト：128）
const int STICK_CENTER_Y = 128;

// スティック X 軸の遊び範囲（デフォルト：10）
const int STICK_DEADZONE_X = 10;

// スティック Y 軸の遊び範囲（デフォルト：10）
const int STICK_DEADZONE_Y = 10;

// スティック X 軸の可動範囲（デフォルト：90）
const int STICK_RANGE_X = 90;

// スティック Y 軸の可動範囲（デフォルト：90）
const int STICK_RANGE_Y = 90;

// 加速度 X 軸の中心値（デフォルト：512）
const int ACCEL_CENTER_X = 512;

// 加速度 Y 軸の中心値（デフォルト：512）
const int ACCEL_CENTER_Y = 512;

// 加速度 Z 軸の中心値（デフォルト：512）
const int ACCEL_CENTER_Z = 512;

// 誤差が大きい加速度を平滑化するためのサンプリング数（デフォルト：50）
// ※ 10 〜 100 の間での運用を推奨します。250 を超えると Arduino 上のメモリが不足する恐れがあります。
const int ACCEL_SMOOTHING_SAMPLES = 50;

// ◤◢◤◢ マウスの挙動 ◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢

// マウス操作のディレイ（デフォルト：10 [ミリ秒単位]）
// 増減することで、全体の速さを調整することができます。
const int MOUSE_DELAY = 10;

// マウスカーソルの最大移動量（デフォルト：5）
const int MOVEMENT_CURSOR = 5;

// ホイールの最大移動量（デフォルト：1）
const int MOVEMENT_WHEEL = 1;

// ホイールによるスクロール方向を反転する（デフォルト：false）
const bool ENABLE_SCROLL_REVERSE = false;

// ホイールモードのスティック左右に「戻る」「進む」機能を割り当てる（デフォルト：true）
const bool ENABLE_SHORTCUT_FUNCTIONS = true;

// ショートカットボタン（進む、戻る）の待機回数（`ENABLE_SHORTCUT_FUNCTIONS` 有効時）
// ※ 待機時間は MOUSE_DELAY を掛けた値（ミリ秒）となる。
const int SHORTCUT_WAIT_TIME = 100;

// ◤◢◤◢ モード切替ロジック ◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢

// モード切替で判定する向き（デフォルト：AXIS_Y_NEG）
// - AXIS_X_NEG : X 軸方向マイナス、左傾斜
// - AXIS_X_POS : X 軸方向プラス、右傾斜
// - AXIS_Y_NEG : Y 軸方向マイナス、後傾
// - AXIS_Y_POS : Y 軸方向プラス、前傾
// - AXIS_Z_NEG : Z 軸方向マイナス、裏向き
// - AXIS_Z_POS : Z 軸方向プラス、表向き
const TargetAxis TARGET_AXIS = AXIS_Y_NEG;

// 向き判定で許容する角度（デフォルト：30.0）
// ※ 大きいほど判定が緩くなるので注意
const float MODE_SWITCH_ANGLE_MARGIN = 30.0;

// ◤◢◤◢ ボタンマッピング ◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤◢◤

// モードに応じたボタンマッピング（デフォルト：{MOUSE_LEFT,MOUSE_RIGHT},{MOUSE_LEFT,MOUSE_MIDDLE}）
// 対応関係は下記となっています、`MOUSE_LEFT`, `MOUSE_RIGHT`, `MOUSE_MIDDLE` を割り当ててください
//
// { カーソルモードのCボタン , カーソルモードのZボタン },
// { ホイールモードのCボタン , ホイールモードのZボタン }
const int MOUSE_BUTTON_MAPS[2][2] = {
  { MOUSE_LEFT, MOUSE_RIGHT },
  { MOUSE_LEFT, MOUSE_MIDDLE }
};
```

:::

上記設定項目を書き換えることで、コントローラーの個体差を補正したり、より自身にあった形に調整することができます。

### 調整手順

ここでは、調整手順の 1 例を示します。

#### デバッグモードを有効化する

まずはコントローラーの個体差がないかを確認するために、デバッグモードを有効化します。

デバッグモードを有効化するには、コード内にある設定項目「[デバッグ及びLED](#デバッグ及びled)」内にある `ENABLE_DEBUG_MODE` の値を `true` に書き換えます。

![上図のコードを変更し、デバッグ有効化した状態](/images/books/nunchuk-mouse/ide-debug-02.png)

その状態で Arduino に書き込むと、**コントローラーがマウスとして機能しなくなる**代わりに**各種情報をシリアルモニタ上に出力**するようになります。

出力内容を確認するためには、IDE 画面左上にある「シリアルモニタ」をクリックします。すると下図のように、各種情報を確認できるようになります。

![IDE のシリアルモニタをクリックし、シリアル通信を表示](/images/books/nunchuk-mouse/ide-debug-03.png)

#### シリアルモニタに各種情報を出力する

![デバッグモードで各種情報がシリアルモニタに出力されている](/images/books/nunchuk-mouse/ide-debug-00.gif)

上図はシリアルモニタの経過を映したものです。これは 1 回で行う処理の計測値（下記参照）を、秒間あたり複数回出力している状態です。

```txt:1行が1回の出力内容となる
S(128,186) -> Mv(-1, 5, 1, 0) | A( 532, 320, 724) -> As( 524, 323, 723) -> X_POS | Mode:0 | C:1 Z:0
```

`S` や `A` といった 各要素の意味については、下表を参照してください。

|名前|説明|備考|
|:---|:---|:---|
|`S`|スティック(*Stick*)入力値、形式は `(x, y)`|中心値はおおよそ 128|
|`Mv`|スティック入力値を各種マウス機能(*Move*)に変換したもの、形式は `(カーソル X, カーソル Y, ホイール W, ショートカット S)`||
|`A`|加速度情報(*Accel*)、形式は `(x, y, z)`|中心値はおおよそ 512|
|`As`|平滑化処理を施した加速度情報(*AccelSmoothed*)、形式は `(x, y, z)`|通常の加速度情報に比べ、計測誤差のブレ幅が小さいことが確認できる|
|`X_POS`|デバイス向きを 5 文字で表現|最初の 1 文字が `軸`、後ろ 3 文字が`±` を表す|
|`Mode`|傾きによるモード判定|`0` がカーソルモード、`1` がホイールモード|
|`C`|C ボタンの状態|`0` が解放、`1` が押下状態|
|`Z`|Z ボタンの状態|`0` が解放、`1` が押下状態|

ここではコントローラーの補正に使うため、スティックの情報を控えておきます。

:::message

加速度情報を控えておき、補正することも可能ではありますが原則は不要です。詳しくは[各種設定項目](#各種設定項目)の `ACCEL_CENTER_*` を参照ください。

:::

#### スティック情報を控えておく

スティックに関する下記の情報を控えておきます。

- 何も触れてない状態の値を調べる（これがスティック中心値となります）
- スティックに触れずにコントローラーを揺らし、値が変化しないか確認する
  - 変化する場合は、その変動幅を調べる（これが遊び範囲となります）
- スティックを傾け、入力可能な範囲を調べる（これが可動範囲となります）

#### 出力内容を基に補正

上記内容を基に、コードの中にある設定項目を編集します。編集する項目は下表のとおりです。

|情報|対応する設定項目|
|:---|:---|
|スティック中心軸|`STICK_CENTER_*`(`X`, `Y`)|
|スティック遊び範囲|`STICK_DEADZONE_*`(`X`, `Y`)|
|スティック可動範囲|`STICK_RANGE_*`(`X`, `Y`)|

#### その他調整を施す

[各種設定項目](#各種設定項目)にある内容のうち、必要となる箇所を調整します。

最終的にデバッグモード（`ENABLE_DEBUG_MODE`）を無効（`false`）にし、ボードに書き込んだら調整は完了です。

## 各種設定項目

本段落では、各種設定項目と その内容について個別に見ていきます。

### デバッグ及びLED

ここではデバッグに関する設定を行います。

#### `ENABLE_DEBUG_MODE`

```cpp
// デバッグモードを有効化する（デフォルト：false）
// ※ デバッグ時は、IDE シリアルモニター上に状態を出力します
const bool ENABLE_DEBUG_MODE = false;
```

デバッグモードを有効化する場合に、`true` に設定します。

デバッグモードを有効化して Arduino に書き込むと、マウスとしては機能しなくなる代わりに各種情報をシリアルモニタを通じて出力することができます。

![デバッグモードで各種情報がシリアルモニタに出力されている](/images/books/nunchuk-mouse/ide-debug-00.gif)

#### `ENABLE_LED`

```cpp
// 状態を可視化するため LED を使用する（デフォルト：true）
// ※ 点灯はホイールモード、点滅は接続エラーを示します
const bool ENABLE_LED = true;
```

状態を知らせるために LED を利用する場合に有効化します。

デフォルトの状態は、オンボードの LED（ピン番号 13）を使い状態を知らせます。点灯がホイールモード、点滅が接続エラーを意味します。

##### `LEDPIN`

```cpp
// 使用する LED ピン番号（デフォルト：13）
// ※ ENABLE_LED 有効時に使用します。デフォルトの 13 は、Arduino のオンボード LED です。
const int LEDPIN = 13;
```

状態を知らせるために使う LED のピン番号を指定します。`ENABLE_LED` が有効時のみ利用します。

### デバイス関係

ここでは使用する機器に関する設定を行います。

#### `IS_NUNCHUK_SHIRO`

```cpp
// ヌンチャク種別、クロの場合は false に変更（デフォルト：true）
const bool IS_NUNCHUK_SHIRO = true;
```

使用するコントローラーが「クロ」である場合に、`false` を設定します。

これはコントローラーは製造時期によって「シロ」「クロ」と分かれており、それぞれで初期化するための処理が異なっているためです。

#### `IS_MACINTOSH`

```cpp
// Macintosh の場合は true に変更（デフォルト：false）
const bool IS_MACINTOSH = false;
```

Arduino を接続する PC が Mac である場合に、`true` を設定します。

これは「進む」「戻る」ショートカットキーが、Windows や Linux 系が `Alt` + `←`（または `→`）であるのに対し、Mac では `Command` + `[`（または `]`）と異なるためです。

### ヌンチャク物理特性のデフォルト値

ここではコントローラーの物理機能に関する設定を行い、補正を施します。

#### `STICK_CENTER_*`（`X`, `Y`）

```cpp
 // スティック X 軸の中心値（デフォルト：128）
const int STICK_CENTER_X = 128;

// スティック Y 軸の中心値（デフォルト：128）
const int STICK_CENTER_Y = 128;
```

スティック入力の中心値を設定します。

想定ではスティック入力の中心値は 128 ですが、製品としての個体差等でズレることが考えられます。この設定は そうしたズレを補正するためにあります。

デフォルトの `128` は、スティック入力の中心値が 128 であることを示しています。

#### `STICK_DEADZONE_*`（`X`, `Y`）

```cpp
// スティック X 軸の遊び範囲（デフォルト：10）
const int STICK_DEADZONE_X = 10;

// スティック Y 軸の遊び範囲（デフォルト：10）
const int STICK_DEADZONE_Y = 10;
```

スティック入力の遊び範囲を設定します。

コントローラーによってはスティックが経年劣化し、触れていなくてもスティック値が微小に変化する場合があります。この設定は、このような意図せぬ微小な変化をマウスに伝達しないよう、スティックの遊び範囲を設けるためにあります。

デフォルトの `10` は、中心値からプラスマイナス 10 を遊び範囲とし、スティック入力値がこの範囲内である場合は「入力なし」と みなします。  
（例：中心値 `128` と仮定した場合、`118` 〜 `138`）

#### `STICK_RANGE_*`（`X`, `Y`）

```cpp
// スティック X 軸の可動範囲（デフォルト：90）
const int STICK_RANGE_X = 90;

// スティック Y 軸の可動範囲（デフォルト：90）
const int STICK_RANGE_Y = 90;
```

スティックで入力可能な範囲を設定します。

デバッグモードでのスティック入力値を確認すると、おおよそ `128` 中心で、大きく傾けても `0` や `256` にならないことがわかります。この設定は入力可能な範囲を設定し、それに合わせてカーソル移動量を規定するためにあります。

デフォルトの `90` は、中心値からプラスマイナス 90 の範囲で変動することを示します。  
（例：中心値 `128` と仮定した場合、`38` 〜 `218`）

#### `ACCEL_CENTER_*`（`X`, `Y`, `Z`）

```cpp
// 加速度 X 軸の中心値（デフォルト：512）
const int ACCEL_CENTER_X = 512;

// 加速度 Y 軸の中心値（デフォルト：512）
const int ACCEL_CENTER_Y = 512;

// 加速度 Z 軸の中心値（デフォルト：512）
const int ACCEL_CENTER_Z = 512;
```

加速度センサーの中心値を調整します。デバイスの計測誤差が大きいときにのみ調整してください。

中心値については `ENABLE_DEBUG_MODE` を有効化し、スティックが天井方向を指すよう持つ（下図参照）ことで `X`, `Y` を調べることができます。

![通常時のコントローラー](/images/books/nunchuk-mouse/nunchuck_data-00.png =240x)

上図は `Z` の中心位置ではないため、左右または上下に 90°傾けることで調べることができます。

:::message

最初に書いた通り、基本的にはこの設定を弄らないことをオススメします。動作内容を理解した上で、デバイスの計測誤差が大きいときにのみ調整してください。

:::

#### `ACCEL_SMOOTHING_SAMPLES`

```cpp
// 誤差が大きい加速度を平滑化するためのサンプリング数（デフォルト：50）
// ※ 10 〜 100 の間での運用を推奨します。250 を超えると Arduino 上のメモリが不足する恐れがあります。
const int ACCEL_SMOOTHING_SAMPLES = 50;
```

加速度センサーのデータを滑らかにするための設定です。

実際の処理では、この値分のサンプリングを取り、移動平均による平滑化処理を行なっています。これはコントローラーの加速度センサーが誤差 10% 程度と大きく、ボタンで言うチャタリング[^1]のように、意図せぬモード切替が頻発する恐れがあるためです。

[^1]: チャタリング：物理的なボタンを押すタイミングで、オンオフの状態が複数回切り替わる状況を指す。

デフォルトの `50` の場合、直近 50 回分の加速度情報を平均した値を処理に使うことを意味します。

設定値を小さくすると、デバイスの傾けに素早く反応しますが誤差が大きくなります。一方で大きくすると、誤差は少なくなりますがデバイスの傾けにゆっくり反応するようになります。

下図はサンプル数を 1 にした状態で、モード切替ギリギリの姿勢にデバイスを傾けた状態です。1秒間で複数のモード切替が起きていることが確認できます。

![サンプル数1でシリアルモニタに表示、モードが1秒の間に頻繁に切り替わっている](/images/books/nunchuk-mouse/acceleration-01.gif)
*`Mode` に注目*

### マウスの挙動

ここではマウス機能に関する設定を行います。

#### `MOUSE_DELAY`

```cpp
// マウス操作のディレイ（デフォルト：10 [ミリ秒単位]）
// 増減することで、全体の速さを調整することができます。
const int MOUSE_DELAY = 10;
```

マウスの反応速度を設定します。

実際の処理では、コントローラーからデータを読み取りマウス操作に反映する 1 回の処理にかかる時間を増減させます。

デフォルトの `10` の場合、1 回の処理を（おおよそ）10 ミリ秒間隔にします。

少なくすると全ての動作が高速に反応することになるため、扱いづらくなる恐れがあります。そのためできるだけ他の項目で調整してみることをおすすめします。

#### `MOVEMENT_CURSOR`

```cpp
// マウスカーソルの最大移動量（デフォルト：5）
const int MOVEMENT_CURSOR = 5;
```

スティックに対する、カーソルの最大移動量を設定します。

実際の処理では、（コントローラーからデータを読み取りマウス操作に反映する）1回の処理での最大移動量となります。

デフォルトの `5` の場合、スティックの傾き具合で `1` 〜 `5` の範囲でカーソルが動きます。

#### `MOVEMENT_WHEEL`

```cpp
// ホイールの最大移動量（デフォルト：1）
const int MOVEMENT_WHEEL = 1;
```

スティックに対する、ホイールの最大移動量を設定します。

実際の処理では、（コントローラーからデータを読み取りマウス操作に反映する）1回の処理での最大移動量となります。

デフォルトの `1` の場合、スティック上下の傾けで `1` 動かす動作となります。

#### `ENABLE_SCROLL_REVERSE`

```cpp
// ホイールによるスクロール方向を反転する（デフォルト：false）
const bool ENABLE_SCROLL_REVERSE = false;
```

ホイールモード時の、スクロール反転を有効化します。

デフォルトの `false` は無効状態で、スティックとスクロール方向が一致しています。

有効化すると、スティック**上**で**下**方向、スティック**下**で**上**方向にスクロールが発生します。

#### `ENABLE_SHORTCUT_FUNCTIONS`

```cpp
// ホイールモードのスティック左右に「戻る」「進む」機能を割り当てる（デフォルト：true）
const bool ENABLE_SHORTCUT_FUNCTIONS = true;
```

ホイールモード時のスティック左右入力で、一般的な 5 ボタンマウスにある「戻る」「進む」機能を有効化します。

実際の処理ではキーボードによるショートカット（例：Windows では `Alt` + `←` で「戻る」）を使って操作しています。

:::message

Mac ではショートカットのキーが他と異なるため、`IS_MACINTOSH` を `true` にする操作が必要となります。

:::

##### `SHORTCUT_WAIT_TIME`

```cpp
// ショートカットボタン（進む、戻る）の待機回数（`ENABLE_SHORTCUT_FUNCTIONS` 有効時）
// ※ 待機時間は MOUSE_DELAY を掛けた値（ミリ秒）となる。
const int SHORTCUT_WAIT_TIME = 100;
```

ショートカットボタンの待機時間を設定します。  
（※ `ENABLE_SHORTCUT_FUNCTIONS` が `true` 時に反映されます）

スティックの傾きでボタン機能が有効になるため、この待機時間を設けないと、傾ける動作 1 回で複数回の「戻る」「進む」イベントが発火してしまうことになりかねません。

この待機時間は 一度イベントが発火すると、一定時間 再発火が起きないよう待機状態を発生させます。

実際の処理では、おおよそ `MOUSE_DELAY`（デフォルト時：`10`）と掛け合わせた時間（ミリ秒）分の待機時間を発生させます。デフォルトの `100` ですと、`10 * 100 = 1000`（ミリ秒）となります。

### モード切替ロジック

モード切替判定の設定（向き、許容する角度誤差）を行います。

#### `TARGET_AXIS`

```cpp
// モード切替で判定する向き（デフォルト：AXIS_Y_NEG）
// - AXIS_X_NEG : X 軸方向マイナス、左傾斜
// - AXIS_X_POS : X 軸方向プラス、右傾斜
// - AXIS_Y_NEG : Y 軸方向マイナス、後傾
// - AXIS_Y_POS : Y 軸方向プラス、前傾
// - AXIS_Z_NEG : Z 軸方向マイナス、裏向き
// - AXIS_Z_POS : Z 軸方向プラス、表向き
const TargetAxis TARGET_AXIS = AXIS_Y_NEG;
```

![コントローラー6方向の図と対応する定数名](/images/books/nunchuk-mouse/axis-02.png)

モード切替を行う向きを、上図 6 方向から指定します。

デフォルトの `AXIS_Y_NEG` は 図で言う *Pitch Up(Lean Backward)* に相当し、コントローラーを縦（ボタンを天井方向）に向ける動作となります。

#### `MODE_SWITCH_ANGLE_MARGIN`

```cpp
// 向き判定で許容する角度（デフォルト：30.0）
// ※ 大きいほど判定が緩くなるので注意
const float MODE_SWITCH_ANGLE_MARGIN = 30.0;
```

`TARGET_AXIS` で指定した向きに対し、実際のデバイス向きとの誤差をどれくらい許容するかを、角度で設定します。

デフォルトの `30.0` では、お互いの向きが 30°以内に収まっていればモード切替を実施します。

### ボタンマッピング

モードに応じたボタン（C, Z）のマッピング設定を行います。

#### `MOUSE_BUTTON_MAPS`

```cpp
// モードに応じたボタンマッピング（デフォルト：{MOUSE_LEFT,MOUSE_RIGHT},{MOUSE_LEFT,MOUSE_MIDDLE}）
// 対応関係は下記となっています、`MOUSE_LEFT`, `MOUSE_RIGHT`, `MOUSE_MIDDLE` を割り当ててください
//
// { カーソルモードのCボタン , カーソルモードのZボタン },
// { ホイールモードのCボタン , ホイールモードのZボタン }
const int MOUSE_BUTTON_MAPS[2][2] = {
  { MOUSE_LEFT, MOUSE_RIGHT },
  { MOUSE_LEFT, MOUSE_MIDDLE }
};
```

カーソル/ホイール モード間で、C, Z ボタンに割り当てるマウスボタンを設定します。入力可能な設定値は、下記の 3 つです。

- 左ボタン（`MOUSE_LEFT`）
- 中ボタン（`MOUSE_MIDDLE`）
- 右ボタン（`MOUSE_RIGHT`）

最初に掲載したデフォルト設定を表にすると、下表になります。

|**モード＼ボタン**|**C**|**Z**|
|:---:|:---:|:---:|
|**カーソル**|`MOUSE_LEFT`|`MOUSE_RIGHT`|
|**ホイール**|`MOUSE_LEFT`|`MOUSE_MIDDLE`|

## まとめ

本項では、設定項目を変更する方法について説明しました。

実際にマウスとして使う場合には、コントローラの個体差補正や、ユーザーの利便性に合わせた調整が必須となります。

本リポジトリではコード内のパラメータを切り出し、設定項目という形で調整可能な形にしております。またデータの確認用にデバッグモードを設け、これらの調整が容易になるように設計してあります。

次章からは、コードを作成する前段階である「設計」について解説していきます。
